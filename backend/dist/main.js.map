{"version":3,"sources":["../src/main.ts"],"sourcesContent":["import compress from '@fastify/compress';\nimport helmet from '@fastify/helmet';\nimport { BadRequestException, Logger, ValidationPipe, VersioningType } from '@nestjs/common';\nimport { NestFactory } from '@nestjs/core';\nimport { FastifyAdapter, NestFastifyApplication } from '@nestjs/platform-fastify';\nimport { ValidationError, useContainer } from 'class-validator';\nimport dayjs from 'dayjs';\nimport { WINSTON_MODULE_PROVIDER } from 'nest-winston';\nimport { performance } from 'perf_hooks';\nimport { AppModule } from './app.module';\nimport settings from './common/config/index';\nimport { HttpExceptionFilter } from './common/filters/http-exception.filter';\nimport { isProduction } from './common/utils/is-environment.util';\n\nasync function bootstrap(): Promise<void> {\n  const logger = new Logger('Bootstrap');\n  const startTime = performance.now();\n  const isProd = isProduction();\n\n  try {\n    const fastifyAdapter = createOptimizedFastifyAdapter(isProd);\n    const app = await NestFactory.create<NestFastifyApplication>(AppModule, fastifyAdapter, {\n      logger: isProd ? ['error', 'warn'] : ['log', 'debug', 'error', 'verbose', 'warn'],\n      abortOnError: isProd,\n      forceCloseConnections: true,\n      rawBody: true,\n    });\n\n    useContainer(app.select(AppModule), { fallbackOnErrors: true });\n\n    setupGlobalPipes(app, isProd);\n    setupGlobalFilters(app);\n    setupCors(app, isProd);\n    setupVersioning(app);\n    await Promise.all([setupSecurity(app, isProd), setupCompression(app, isProd)]);\n\n    setupGracefulShutdown(app, logger);\n\n    const port = Number(settings.PORT) || 3000;\n    const host = '0.0.0.0';\n\n    await app.listen(port, host);\n\n    const bootTime = Math.round(performance.now() - startTime);\n\n    logger.log(`ðŸš€ Application started successfully!`);\n    logger.log(`ðŸ“ Server running on: http://${host}:${port}`);\n    logger.log(`ðŸŒ Environment: ${settings.NODE_ENV}`);\n    logger.log(`âš¡ Boot time: ${bootTime}ms`);\n    logger.log(`ðŸ’¾ Memory usage: ${Math.round(process.memoryUsage().heapUsed / 1024 / 1024)}MB`);\n  } catch (error) {\n    logger.error('âŒ Failed to start application:', error);\n    process.exit(1);\n  }\n}\n\nfunction createOptimizedFastifyAdapter(isProd: boolean): FastifyAdapter {\n  return new FastifyAdapter({\n    trustProxy: true,\n    logger: isProd\n      ? false\n      : {\n        level: 'info',\n      },\n    caseSensitive: false,\n    ignoreTrailingSlash: true,\n    maxParamLength: 100,\n    keepAliveTimeout: 72000,\n    requestTimeout: 30000,\n    bodyLimit: 10 * 1024 * 1024,\n    connectionTimeout: 0,\n    pluginTimeout: 30000,\n    serializerOpts: {\n      schema: {},\n    },\n    clientErrorHandler: (error: any, socket: any) => {\n      const logger = new Logger('ClientError');\n      logger.error('Client connection error:', error.message);\n      socket.end('HTTP/1.1 400 Bad Request\\r\\n\\r\\n');\n    },\n  });\n}\n\nfunction setupGlobalPipes(app: NestFastifyApplication, isProd: boolean): void {\n  app.useGlobalPipes(\n    new ValidationPipe({\n      transform: true,\n      transformOptions: { enableImplicitConversion: true, exposeDefaultValues: true },\n      whitelist: true,\n      forbidNonWhitelisted: true,\n      disableErrorMessages: isProd,\n      exceptionFactory: (validationErrors: ValidationError[] = []) => {\n        const formattedErrors = formatValidationErrors(validationErrors);\n        return new BadRequestException({\n          message: 'Validation failed',\n          errors: formattedErrors,\n          timestamp: dayjs().format(),\n        });\n      },\n      stopAtFirstError: isProd,\n    }),\n  );\n}\n\nfunction setupGlobalFilters(app: NestFastifyApplication): void {\n  const winstonLogger = app.get(WINSTON_MODULE_PROVIDER);\n  app.useGlobalFilters(new HttpExceptionFilter(winstonLogger));\n}\n\nasync function setupSecurity(app: NestFastifyApplication, isProd: boolean): Promise<void> {\n  await app.register(helmet, {\n    contentSecurityPolicy: {\n      directives: {\n        defaultSrc: [\"'self'\"],\n        styleSrc: [\"'self'\", \"'unsafe-inline'\", 'fonts.googleapis.com'],\n        fontSrc: [\"'self'\", 'fonts.gstatic.com'],\n        imgSrc: [\"'self'\", 'data:', 'https:'],\n        scriptSrc: isProd ? [\"'self'\"] : [\"'self'\", \"'unsafe-inline'\", \"'unsafe-eval'\"],\n      },\n    },\n    crossOriginEmbedderPolicy: isProd,\n    hsts: { maxAge: 31536000, includeSubDomains: true, preload: true },\n    noSniff: true,\n    frameguard: { action: 'deny' },\n    xssFilter: true,\n  });\n}\n\nasync function setupCompression(app: NestFastifyApplication, isProd: boolean): Promise<void> {\n  await app.register(compress, {\n    global: true,\n    threshold: 1024,\n    encodings: ['gzip', 'deflate', 'br'],\n    zlibOptions: {\n      level: isProd ? 6 : 1,\n    },\n  });\n}\n\nfunction setupCors(app: NestFastifyApplication, isProd: boolean): void {\n  const allowedOrigins = isProd\n    ? [settings.FRONTEND_URL].filter(Boolean)\n    : ['http://localhost:3000', 'http://localhost:3001', settings.FRONTEND_URL].filter(Boolean);\n\n  app.enableCors({\n    origin: (origin, callback) => {\n      // Allow requests with no origin (like mobile apps or curl requests)\n      if (!origin) return callback(null, true);\n      if (allowedOrigins.includes(origin)) return callback(null, true);\n      // In development, allow all localhost origins for testing\n      if (!isProd && /localhost|127\\.0\\.0\\.1/.test(origin)) return callback(null, true);\n      return callback(new Error('Not allowed by CORS'), false);\n    },\n    credentials: true,\n    methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS', 'HEAD'],\n    allowedHeaders: ['Content-Type', 'Authorization', 'x-keyguard-signature', 'x-keyguard-timestamp', 'x-keyguard-nonce', 'x-keyguard-body-sha256', 'x-keyguard-key-id', 'x-keyguard-api-key', 'x-keyguard-alg'],\n  });\n}\n\nfunction setupVersioning(app: NestFastifyApplication): void {\n  app.enableVersioning({\n    type: VersioningType.URI,\n    defaultVersion: '1',\n    prefix: 'v',\n  });\n  app.setGlobalPrefix('api');\n}\n\nfunction setupGracefulShutdown(app: NestFastifyApplication, logger: Logger) {\n  const signals: NodeJS.Signals[] = ['SIGINT', 'SIGTERM'];\n  signals.forEach(signal => {\n    // eslint-disable-next-line @typescript-eslint/no-misused-promises\n    process.on(signal, async () => {\n      logger.warn(`Received ${signal}, shutting down gracefully...`);\n      await app.close();\n      logger.log('Application shutdown complete');\n      process.exit(0);\n    });\n  });\n}\n\nfunction formatValidationErrors(errors: ValidationError[]) {\n  return errors.map(err => ({\n    field: err.property,\n    errors: Object.values(err.constraints ?? {}),\n  }));\n}\n\nvoid bootstrap();\n"],"names":["bootstrap","logger","Logger","startTime","performance","now","isProd","isProduction","fastifyAdapter","createOptimizedFastifyAdapter","app","NestFactory","create","AppModule","abortOnError","forceCloseConnections","rawBody","useContainer","select","fallbackOnErrors","setupGlobalPipes","setupGlobalFilters","setupCors","setupVersioning","Promise","all","setupSecurity","setupCompression","setupGracefulShutdown","port","Number","settings","PORT","host","listen","bootTime","Math","round","log","NODE_ENV","process","memoryUsage","heapUsed","error","exit","FastifyAdapter","trustProxy","level","caseSensitive","ignoreTrailingSlash","maxParamLength","keepAliveTimeout","requestTimeout","bodyLimit","connectionTimeout","pluginTimeout","serializerOpts","schema","clientErrorHandler","socket","message","end","useGlobalPipes","ValidationPipe","transform","transformOptions","enableImplicitConversion","exposeDefaultValues","whitelist","forbidNonWhitelisted","disableErrorMessages","exceptionFactory","validationErrors","formattedErrors","formatValidationErrors","BadRequestException","errors","timestamp","dayjs","format","stopAtFirstError","winstonLogger","get","WINSTON_MODULE_PROVIDER","useGlobalFilters","HttpExceptionFilter","register","helmet","contentSecurityPolicy","directives","defaultSrc","styleSrc","fontSrc","imgSrc","scriptSrc","crossOriginEmbedderPolicy","hsts","maxAge","includeSubDomains","preload","noSniff","frameguard","action","xssFilter","compress","global","threshold","encodings","zlibOptions","allowedOrigins","FRONTEND_URL","filter","Boolean","enableCors","origin","callback","includes","test","Error","credentials","methods","allowedHeaders","enableVersioning","type","VersioningType","URI","defaultVersion","prefix","setGlobalPrefix","signals","forEach","signal","on","warn","close","map","err","field","property","Object","values","constraints"],"mappings":"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"}