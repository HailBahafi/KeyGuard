{"version":3,"sources":["../../../src/modules/keyguard/keyguard.controller.ts"],"sourcesContent":["import { Public } from '@/src/common/decorators/public.decorator';\nimport {\n  BadRequestException,\n  Body,\n  Controller,\n  Delete,\n  Get,\n  Headers,\n  HttpCode,\n  HttpStatus,\n  Logger,\n  Param,\n  Post,\n  Req,\n} from '@nestjs/common';\nimport { FastifyRequest } from 'fastify';\nimport { EnrollDeviceDto, EnrollResponseDto, VerifyResponseDto } from './dto';\nimport { KeyGuardService } from './services/keyguard.service';\n/**\n * KeyGuard Controller - Handles device enrollment and signature verification\n * All endpoints are public (use their own x-keyguard-api-key authentication)\n */\n@Public()\n@Controller('keyguard')\nexport class KeyGuardController {\n  private readonly logger = new Logger(KeyGuardController.name);\n  constructor(private readonly keyguardService: KeyGuardService) { }\n  /**\n   * Enroll a new device by storing its public key\n   *\n   * POST /api/v1/keyguard/enroll\n   */\n  @Post('enroll')\n  @HttpCode(HttpStatus.CREATED)\n  async enroll(\n    @Headers('x-keyguard-api-key') apiKey: string,\n    @Body() enrollDto: EnrollDeviceDto,\n  ): Promise<EnrollResponseDto> {\n    if (!apiKey) {\n      throw new BadRequestException('x-keyguard-api-key header is required');\n    }\n    this.logger.log(`Enrollment request for keyId: ${enrollDto.keyId}`);\n    return this.keyguardService.enrollDevice(apiKey, enrollDto);\n  }\n  /**\n   * Verify a signed request (test endpoint for Phase 1)\n   *\n   * POST /api/v1/keyguard/verify-test\n   */\n  @Post('verify-test')\n  @HttpCode(HttpStatus.OK)\n  async verifyTest(\n    @Req() request: FastifyRequest & { rawBody?: Buffer },\n    @Headers('x-keyguard-api-key') apiKey: string,\n    @Headers('x-keyguard-key-id') keyId: string,\n    @Headers('x-keyguard-timestamp') timestamp: string,\n    @Headers('x-keyguard-nonce') nonce: string,\n    @Headers('x-keyguard-body-sha256') bodySha256: string,\n    @Headers('x-keyguard-alg') algorithm: string,\n    @Headers('x-keyguard-signature') signature: string,\n    @Body() body?: unknown,\n  ): Promise<VerifyResponseDto> {\n    // Validate required headers\n    const missingHeaders = [];\n    if (!apiKey) missingHeaders.push('x-keyguard-api-key');\n    if (!keyId) missingHeaders.push('x-keyguard-key-id');\n    if (!timestamp) missingHeaders.push('x-keyguard-timestamp');\n    if (!nonce) missingHeaders.push('x-keyguard-nonce');\n    if (!bodySha256) missingHeaders.push('x-keyguard-body-sha256');\n    if (!algorithm) missingHeaders.push('x-keyguard-alg');\n    if (!signature) missingHeaders.push('x-keyguard-signature');\n    if (missingHeaders.length > 0) {\n      throw new BadRequestException(\n        `Missing required headers: ${missingHeaders.join(', ')}`,\n      );\n    }\n    const headers = {\n      apiKey,\n      keyId,\n      timestamp,\n      nonce,\n      bodySha256,\n      algorithm,\n      signature,\n    };\n    // Get raw body from request\n    const rawBody = request.rawBody ?? null;\n    // Get method and URL\n    const method = request.method;\n    const url = request.url;\n    this.logger.log(`Verification test request: ${method} ${url}`);\n    return this.keyguardService.verifyRequest(headers, method, url, rawBody);\n  }\n  /**\n   * Get device by ID\n   *\n   * GET /api/v1/keyguard/devices/:id\n   */\n  @Get('devices/:id')\n  async getDevice(\n    @Headers('x-keyguard-api-key') apiKey: string,\n    @Param('id') id: string,\n  ) {\n    if (!apiKey) {\n      throw new BadRequestException('x-keyguard-api-key header is required');\n    }\n    return this.keyguardService.getDevice(id);\n  }\n  /**\n   * List all devices for an API key\n   *\n   * GET /api/v1/keyguard/devices\n   */\n  @Get('devices')\n  async listDevices(@Headers('x-keyguard-api-key') apiKey: string) {\n    if (!apiKey) {\n      throw new BadRequestException('x-keyguard-api-key header is required');\n    }\n    return this.keyguardService.listDevices(apiKey);\n  }\n  /**\n   * Revoke a device\n   *\n   * DELETE /api/v1/keyguard/devices/:id\n   */\n  @Delete('devices/:id')\n  @HttpCode(HttpStatus.OK)\n  async revokeDevice(\n    @Headers('x-keyguard-api-key') apiKey: string,\n    @Param('id') id: string,\n  ) {\n    if (!apiKey) {\n      throw new BadRequestException('x-keyguard-api-key header is required');\n    }\n    return this.keyguardService.revokeDevice(apiKey, id);\n  }\n}\n"],"names":["KeyGuardController","enroll","apiKey","enrollDto","BadRequestException","logger","log","keyId","keyguardService","enrollDevice","verifyTest","request","timestamp","nonce","bodySha256","algorithm","signature","body","missingHeaders","push","length","join","headers","rawBody","method","url","verifyRequest","getDevice","id","listDevices","revokeDevice","Logger","name","CREATED","OK"],"mappings":";;;;+BAwBaA;;;eAAAA;;;iCAxBU;wBAchB;qBAE+D;iCACtC;;;;;;;;;;;;;;;AAOzB,IAAA,AAAMA,qBAAN,MAAMA;IAGX;;;;GAIC,GACD,MAEMC,OACJ,AAA+BC,MAAc,EAC7C,AAAQC,SAA0B,EACN;QAC5B,IAAI,CAACD,QAAQ;YACX,MAAM,IAAIE,2BAAmB,CAAC;QAChC;QACA,IAAI,CAACC,MAAM,CAACC,GAAG,CAAC,CAAC,8BAA8B,EAAEH,UAAUI,KAAK,EAAE;QAClE,OAAO,IAAI,CAACC,eAAe,CAACC,YAAY,CAACP,QAAQC;IACnD;IACA;;;;GAIC,GACD,MAEMO,WACJ,AAAOC,OAA8C,EACrD,AAA+BT,MAAc,EAC7C,AAA8BK,KAAa,EAC3C,AAAiCK,SAAiB,EAClD,AAA6BC,KAAa,EAC1C,AAAmCC,UAAkB,EACrD,AAA2BC,SAAiB,EAC5C,AAAiCC,SAAiB,EAClD,AAAQC,IAAc,EACM;QAC5B,4BAA4B;QAC5B,MAAMC,iBAAiB,EAAE;QACzB,IAAI,CAAChB,QAAQgB,eAAeC,IAAI,CAAC;QACjC,IAAI,CAACZ,OAAOW,eAAeC,IAAI,CAAC;QAChC,IAAI,CAACP,WAAWM,eAAeC,IAAI,CAAC;QACpC,IAAI,CAACN,OAAOK,eAAeC,IAAI,CAAC;QAChC,IAAI,CAACL,YAAYI,eAAeC,IAAI,CAAC;QACrC,IAAI,CAACJ,WAAWG,eAAeC,IAAI,CAAC;QACpC,IAAI,CAACH,WAAWE,eAAeC,IAAI,CAAC;QACpC,IAAID,eAAeE,MAAM,GAAG,GAAG;YAC7B,MAAM,IAAIhB,2BAAmB,CAC3B,CAAC,0BAA0B,EAAEc,eAAeG,IAAI,CAAC,OAAO;QAE5D;QACA,MAAMC,UAAU;YACdpB;YACAK;YACAK;YACAC;YACAC;YACAC;YACAC;QACF;QACA,4BAA4B;QAC5B,MAAMO,UAAUZ,QAAQY,OAAO,IAAI;QACnC,qBAAqB;QACrB,MAAMC,SAASb,QAAQa,MAAM;QAC7B,MAAMC,MAAMd,QAAQc,GAAG;QACvB,IAAI,CAACpB,MAAM,CAACC,GAAG,CAAC,CAAC,2BAA2B,EAAEkB,OAAO,CAAC,EAAEC,KAAK;QAC7D,OAAO,IAAI,CAACjB,eAAe,CAACkB,aAAa,CAACJ,SAASE,QAAQC,KAAKF;IAClE;IACA;;;;GAIC,GACD,MACMI,UACJ,AAA+BzB,MAAc,EAC7C,AAAa0B,EAAU,EACvB;QACA,IAAI,CAAC1B,QAAQ;YACX,MAAM,IAAIE,2BAAmB,CAAC;QAChC;QACA,OAAO,IAAI,CAACI,eAAe,CAACmB,SAAS,CAACC;IACxC;IACA;;;;GAIC,GACD,MACMC,YAAY,AAA+B3B,MAAc,EAAE;QAC/D,IAAI,CAACA,QAAQ;YACX,MAAM,IAAIE,2BAAmB,CAAC;QAChC;QACA,OAAO,IAAI,CAACI,eAAe,CAACqB,WAAW,CAAC3B;IAC1C;IACA;;;;GAIC,GACD,MAEM4B,aACJ,AAA+B5B,MAAc,EAC7C,AAAa0B,EAAU,EACvB;QACA,IAAI,CAAC1B,QAAQ;YACX,MAAM,IAAIE,2BAAmB,CAAC;QAChC;QACA,OAAO,IAAI,CAACI,eAAe,CAACsB,YAAY,CAAC5B,QAAQ0B;IACnD;IA7GA,YAAY,AAAiBpB,eAAgC,CAAE;aAAlCA,kBAAAA;aADZH,SAAS,IAAI0B,cAAM,CAAC/B,mBAAmBgC,IAAI;IACK;AA8GnE;;;6CAvGuBC;;;;;;;;;;;;6CAiBAC;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;;6CA4EAA"}