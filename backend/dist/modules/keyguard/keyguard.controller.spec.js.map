{"version":3,"sources":["../../../src/modules/keyguard/keyguard.controller.spec.ts"],"sourcesContent":["import { Test, TestingModule } from '@nestjs/testing';\nimport { KeyGuardController } from './keyguard.controller';\nimport { KeyGuardService } from './services/keyguard.service';\nimport { BadRequestException } from '@nestjs/common';\nimport { FastifyRequest } from 'fastify';\n\ndescribe('KeyGuardController', () => {\n  let controller: KeyGuardController;\n  let service: KeyGuardService;\n\n  const mockKeyGuardService = {\n    enrollDevice: jest.fn(),\n    verifyRequest: jest.fn(),\n    getDevice: jest.fn(),\n    listDevices: jest.fn(),\n    revokeDevice: jest.fn(),\n  };\n\n  beforeEach(async () => {\n    const module: TestingModule = await Test.createTestingModule({\n      controllers: [KeyGuardController],\n      providers: [\n        {\n          provide: KeyGuardService,\n          useValue: mockKeyGuardService,\n        },\n      ],\n    }).compile();\n\n    controller = module.get<KeyGuardController>(KeyGuardController);\n    service = module.get<KeyGuardService>(KeyGuardService);\n\n    jest.clearAllMocks();\n  });\n\n  it('should be defined', () => {\n    expect(controller).toBeDefined();\n  });\n\n  describe('enroll', () => {\n    const apiKey = 'kg_prod_123';\n    const enrollDto = {\n      publicKey: 'MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAE...',\n      keyId: 'key_abc123',\n      deviceFingerprint: 'fingerprint123',\n      label: \"Ahmed's MacBook\",\n      userAgent: 'Mozilla/5.0...',\n      metadata: { browser: 'Chrome' },\n    };\n\n    it('should successfully enroll a device', async () => {\n      const expectedResponse = {\n        id: 'device-uuid',\n        status: 'ACTIVE',\n        createdAt: new Date(),\n      };\n\n      mockKeyGuardService.enrollDevice.mockResolvedValue(expectedResponse);\n\n      const result = await controller.enroll(apiKey, enrollDto);\n\n      expect(result).toEqual(expectedResponse);\n      expect(mockKeyGuardService.enrollDevice).toHaveBeenCalledWith(\n        apiKey,\n        enrollDto,\n      );\n    });\n\n    it('should throw error if API key header is missing', async () => {\n      await expect(controller.enroll('', enrollDto)).rejects.toThrow(\n        BadRequestException,\n      );\n\n      expect(mockKeyGuardService.enrollDevice).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('verifyTest', () => {\n    const apiKey = 'kg_prod_123';\n    const keyId = 'key_abc123';\n    const timestamp = '2025-12-02T10:30:00.000Z';\n    const nonce = 'nonce123';\n    const bodySha256 = 'hash123';\n    const algorithm = 'ECDSA_P256_SHA256_P1363';\n    const signature = 'signature_base64';\n\n    const mockRequest = {\n      method: 'POST',\n      url: '/api/v1/keyguard/verify-test',\n      rawBody: Buffer.from('{}'),\n    } as FastifyRequest & { rawBody?: Buffer };\n\n    it('should successfully verify request', async () => {\n      const expectedResponse = {\n        valid: true,\n        deviceId: 'device-uuid',\n        keyId: 'key_abc123',\n      };\n\n      mockKeyGuardService.verifyRequest.mockResolvedValue(expectedResponse);\n\n      const result = await controller.verifyTest(\n        mockRequest,\n        apiKey,\n        keyId,\n        timestamp,\n        nonce,\n        bodySha256,\n        algorithm,\n        signature,\n        {},\n      );\n\n      expect(result).toEqual(expectedResponse);\n      expect(mockKeyGuardService.verifyRequest).toHaveBeenCalledWith(\n        {\n          apiKey,\n          keyId,\n          timestamp,\n          nonce,\n          bodySha256,\n          algorithm,\n          signature,\n        },\n        'POST',\n        '/api/v1/keyguard/verify-test',\n        mockRequest.rawBody,\n      );\n    });\n\n    it('should throw error if required headers are missing', async () => {\n      await expect(\n        controller.verifyTest(\n          mockRequest,\n          '', // missing apiKey\n          keyId,\n          timestamp,\n          nonce,\n          bodySha256,\n          algorithm,\n          signature,\n        ),\n      ).rejects.toThrow(BadRequestException);\n\n      expect(mockKeyGuardService.verifyRequest).not.toHaveBeenCalled();\n    });\n\n    it('should handle request without raw body', async () => {\n      const requestWithoutBody = {\n        method: 'POST',\n        url: '/api/v1/keyguard/verify-test',\n      } as FastifyRequest & { rawBody?: Buffer };\n\n      const expectedResponse = {\n        valid: true,\n        deviceId: 'device-uuid',\n        keyId: 'key_abc123',\n      };\n\n      mockKeyGuardService.verifyRequest.mockResolvedValue(expectedResponse);\n\n      const result = await controller.verifyTest(\n        requestWithoutBody,\n        apiKey,\n        keyId,\n        timestamp,\n        nonce,\n        bodySha256,\n        algorithm,\n        signature,\n      );\n\n      expect(result).toEqual(expectedResponse);\n      expect(mockKeyGuardService.verifyRequest).toHaveBeenCalledWith(\n        expect.any(Object),\n        'POST',\n        '/api/v1/keyguard/verify-test',\n        null,\n      );\n    });\n\n    it('should validate all required headers', async () => {\n      const testCases = [\n        { apiKey: '', label: 'x-keyguard-api-key' },\n        { keyId: '', label: 'x-keyguard-key-id' },\n        { timestamp: '', label: 'x-keyguard-timestamp' },\n        { nonce: '', label: 'x-keyguard-nonce' },\n        { bodySha256: '', label: 'x-keyguard-body-sha256' },\n        { algorithm: '', label: 'x-keyguard-alg' },\n        { signature: '', label: 'x-keyguard-signature' },\n      ];\n\n      for (const testCase of testCases) {\n        const headers = {\n          apiKey: testCase.apiKey ?? apiKey,\n          keyId: testCase.keyId ?? keyId,\n          timestamp: testCase.timestamp ?? timestamp,\n          nonce: testCase.nonce ?? nonce,\n          bodySha256: testCase.bodySha256 ?? bodySha256,\n          algorithm: testCase.algorithm ?? algorithm,\n          signature: testCase.signature ?? signature,\n        };\n\n        try {\n          await controller.verifyTest(\n            mockRequest,\n            headers.apiKey,\n            headers.keyId,\n            headers.timestamp,\n            headers.nonce,\n            headers.bodySha256,\n            headers.algorithm,\n            headers.signature,\n          );\n          fail(`Should have thrown error for missing ${testCase.label}`);\n        } catch (error: any) {\n          expect(error).toBeInstanceOf(BadRequestException);\n          expect(error.message).toContain(testCase.label);\n        }\n      }\n    });\n  });\n\n  describe('getDevice', () => {\n    const apiKey = 'kg_prod_123';\n    const deviceId = 'device-uuid';\n\n    it('should return device by ID', async () => {\n      const expectedDevice = {\n        id: deviceId,\n        keyId: 'key_abc',\n        status: 'ACTIVE',\n        label: 'Test Device',\n      };\n\n      mockKeyGuardService.getDevice.mockResolvedValue(expectedDevice);\n\n      const result = await controller.getDevice(apiKey, deviceId);\n\n      expect(result).toEqual(expectedDevice);\n      expect(mockKeyGuardService.getDevice).toHaveBeenCalledWith(deviceId);\n    });\n\n    it('should throw error if API key header is missing', async () => {\n      await expect(controller.getDevice('', deviceId)).rejects.toThrow(\n        BadRequestException,\n      );\n\n      expect(mockKeyGuardService.getDevice).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('listDevices', () => {\n    const apiKey = 'kg_prod_123';\n\n    it('should list all devices', async () => {\n      const expectedDevices = [\n        { id: 'device-1', keyId: 'key_1', status: 'ACTIVE' },\n        { id: 'device-2', keyId: 'key_2', status: 'REVOKED' },\n      ];\n\n      mockKeyGuardService.listDevices.mockResolvedValue(expectedDevices);\n\n      const result = await controller.listDevices(apiKey);\n\n      expect(result).toEqual(expectedDevices);\n      expect(mockKeyGuardService.listDevices).toHaveBeenCalledWith(apiKey);\n    });\n\n    it('should throw error if API key header is missing', async () => {\n      await expect(controller.listDevices('')).rejects.toThrow(\n        BadRequestException,\n      );\n\n      expect(mockKeyGuardService.listDevices).not.toHaveBeenCalled();\n    });\n  });\n\n  describe('revokeDevice', () => {\n    const apiKey = 'kg_prod_123';\n    const deviceId = 'device-uuid';\n\n    it('should revoke a device', async () => {\n      const expectedDevice = {\n        id: deviceId,\n        keyId: 'key_abc',\n        status: 'REVOKED',\n      };\n\n      mockKeyGuardService.revokeDevice.mockResolvedValue(expectedDevice);\n\n      const result = await controller.revokeDevice(apiKey, deviceId);\n\n      expect(result).toEqual(expectedDevice);\n      expect(mockKeyGuardService.revokeDevice).toHaveBeenCalledWith(\n        apiKey,\n        deviceId,\n      );\n    });\n\n    it('should throw error if API key header is missing', async () => {\n      await expect(controller.revokeDevice('', deviceId)).rejects.toThrow(\n        BadRequestException,\n      );\n\n      expect(mockKeyGuardService.revokeDevice).not.toHaveBeenCalled();\n    });\n  });\n});\n"],"names":["describe","controller","service","mockKeyGuardService","enrollDevice","jest","fn","verifyRequest","getDevice","listDevices","revokeDevice","beforeEach","module","Test","createTestingModule","controllers","KeyGuardController","providers","provide","KeyGuardService","useValue","compile","get","clearAllMocks","it","expect","toBeDefined","apiKey","enrollDto","publicKey","keyId","deviceFingerprint","label","userAgent","metadata","browser","expectedResponse","id","status","createdAt","Date","mockResolvedValue","result","enroll","toEqual","toHaveBeenCalledWith","rejects","toThrow","BadRequestException","not","toHaveBeenCalled","timestamp","nonce","bodySha256","algorithm","signature","mockRequest","method","url","rawBody","Buffer","from","valid","deviceId","verifyTest","requestWithoutBody","any","Object","testCases","testCase","headers","fail","error","toBeInstanceOf","message","toContain","expectedDevice","expectedDevices"],"mappings":"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"}