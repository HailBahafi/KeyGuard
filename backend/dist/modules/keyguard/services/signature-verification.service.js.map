{"version":3,"sources":["../../../../src/modules/keyguard/services/signature-verification.service.ts"],"sourcesContent":["import { Injectable, Logger } from '@nestjs/common';\nimport { createHash, webcrypto } from 'node:crypto';\n\nconst subtle = webcrypto.subtle;\n\n/**\n * Service responsible for cryptographic signature verification\n * using ECDSA P-256 with SHA-256 (IEEE P1363 format)\n */\n@Injectable()\nexport class SignatureVerificationService {\n  private readonly logger = new Logger(SignatureVerificationService.name);\n\n  private readonly importParams: EcKeyImportParams = {\n    name: 'ECDSA',\n    namedCurve: 'P-256',\n  };\n\n  private readonly verifyParams: EcdsaParams = {\n    name: 'ECDSA',\n    hash: { name: 'SHA-256' },\n  };\n\n  /**\n   * Verify an ECDSA signature using WebCrypto (matches browser SDK)\n   *\n   * @param publicKeySpkiBase64 - Base64-encoded SPKI public key\n   * @param payload - The exact payload string that was signed\n   * @param signatureBase64 - Base64-encoded signature (IEEE P1363 format)\n   * @returns Promise<boolean> - true if signature is valid\n   */\n  async verifySignature(\n    publicKeySpkiBase64: string,\n    payload: string,\n    signatureBase64: string,\n  ): Promise<boolean> {\n    try {\n      const publicKey = await subtle.importKey(\n        'spki',\n        this.base64ToBuffer(publicKeySpkiBase64),\n        this.importParams,\n        true,\n        ['verify'],\n      );\n\n      const isValid = await subtle.verify(\n        this.verifyParams,\n        publicKey,\n        this.base64ToBuffer(signatureBase64),\n        Buffer.from(payload, 'utf8'),\n      );\n\n      this.logger.debug(`Signature verification result: ${isValid}`);\n      return isValid;\n    } catch (error) {\n      this.logger.error('Signature verification failed:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Build the canonical payload string that must match the SDK's signed payload\n   *\n   * Format: kg-v1|{timestamp}|{METHOD}|{pathAndQuery}|{bodySha256}|{nonce}|{apiKey}|{keyId}\n   *\n   * @param timestamp - ISO8601 timestamp\n   * @param method - HTTP method (uppercase)\n   * @param pathAndQuery - Path and query string (e.g., /api/v1/enroll?foo=bar)\n   * @param bodySha256 - SHA-256 hash of raw body bytes (hex string)\n   * @param nonce - Unique nonce\n   * @param apiKey - Project API key\n   * @param keyId - Device key identifier\n   * @returns Canonical payload string\n   */\n  buildCanonicalPayload(\n    timestamp: string,\n    method: string,\n    pathAndQuery: string,\n    bodySha256: string,\n    nonce: string,\n    apiKey: string,\n    keyId: string,\n  ): string {\n    const parts = [\n      'kg-v1',\n      timestamp,\n      method.toUpperCase(),\n      pathAndQuery,\n      bodySha256,\n      nonce,\n      apiKey,\n      keyId,\n    ];\n\n    const payload = parts.join('|');\n    this.logger.debug(`Built canonical payload: ${payload}`);\n    return payload;\n  }\n\n  /**\n   * Compute SHA-256 hash of raw body bytes\n   *\n   * @param rawBody - Raw body buffer\n   * @returns Hex string of SHA-256 hash\n   */\n  computeBodyHash(rawBody: Buffer | null): string {\n    if (!rawBody || rawBody.length === 0) {\n      // Empty body hash\n      const hash = createHash('sha256').update('').digest('hex');\n      this.logger.debug(`Computed empty body hash: ${hash}`);\n      return hash;\n    }\n\n    const hash = createHash('sha256').update(rawBody).digest('hex');\n    this.logger.debug(`Computed body hash: ${hash}`);\n    return hash;\n  }\n\n  /**\n   * Validate timestamp is within acceptable window (default 120 seconds)\n   *\n   * @param timestamp - ISO8601 timestamp string\n   * @param windowSeconds - Time window in seconds (default: 120)\n   * @returns true if timestamp is within window\n   */\n  validateTimestamp(timestamp: string, windowSeconds = 120): boolean {\n    try {\n      const requestTime = new Date(timestamp).getTime();\n      const now = Date.now();\n      const diff = Math.abs(now - requestTime);\n\n      const isValid = diff <= windowSeconds * 1000;\n\n      if (!isValid) {\n        this.logger.warn(\n          `Timestamp outside window: ${diff}ms (max: ${windowSeconds * 1000}ms)`,\n        );\n      }\n\n      return isValid;\n    } catch (error) {\n      this.logger.error('Invalid timestamp format:', error);\n      return false;\n    }\n  }\n\n  /**\n   * Extract path and query from URL (no scheme/host)\n   *\n   * @param url - Full URL or path\n   * @returns Path and query string (e.g., /api/v1/test?foo=bar)\n   */\n  extractPathAndQuery(url: string): string {\n    try {\n      // If it's a full URL, parse it\n      if (url.startsWith('http://') || url.startsWith('https://')) {\n        const parsed = new URL(url);\n        return parsed.pathname + parsed.search;\n      }\n\n      // Already a path\n      return url;\n    } catch (error) {\n      this.logger.error('Failed to extract path and query:', error);\n      return url;\n    }\n  }\n\n  /**\n   * Validate the algorithm matches expected value\n   *\n   * @param algorithm - Algorithm from header\n   * @returns true if algorithm is supported\n   */\n  validateAlgorithm(algorithm: string): boolean {\n    const supported = ['ECDSA_P256_SHA256_P1363'];\n    const isValid = supported.includes(algorithm);\n\n    if (!isValid) {\n      this.logger.warn(`Unsupported algorithm: ${algorithm}`);\n    }\n\n    return isValid;\n  }\n\n  /**\n   * Convert base64 string to Buffer\n   */\n  private base64ToBuffer(base64: string): Buffer {\n    return Buffer.from(base64, 'base64');\n  }\n}\n"],"names":["SignatureVerificationService","subtle","webcrypto","verifySignature","publicKeySpkiBase64","payload","signatureBase64","publicKey","importKey","base64ToBuffer","importParams","isValid","verify","verifyParams","Buffer","from","logger","debug","error","buildCanonicalPayload","timestamp","method","pathAndQuery","bodySha256","nonce","apiKey","keyId","parts","toUpperCase","join","computeBodyHash","rawBody","length","hash","createHash","update","digest","validateTimestamp","windowSeconds","requestTime","Date","getTime","now","diff","Math","abs","warn","extractPathAndQuery","url","startsWith","parsed","URL","pathname","search","validateAlgorithm","algorithm","supported","includes","base64","Logger","name","namedCurve"],"mappings":"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"}