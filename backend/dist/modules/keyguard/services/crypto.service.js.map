{"version":3,"sources":["../../../../src/modules/keyguard/services/crypto.service.ts"],"sourcesContent":["import { Injectable } from '@nestjs/common';\nimport { createHash, createVerify } from 'crypto';\n\n/**\n * CryptoService - Core cryptographic operations for KeyGuard\n * \n * Handles signature verification for device-bound requests\n */\n@Injectable()\nexport class CryptoService {\n    /**\n     * Verify ECDSA P-256 signature\n     * \n     * @param publicKeyBase64 - Base64-encoded SPKI public key\n     * @param signatureBase64 - Base64-encoded signature (IEEE-P1363 format)\n     * @param payload - Canonical payload string that was signed\n     * @returns true if signature is valid, false otherwise\n     */\n    async verifySignature(\n        publicKeyBase64: string,\n        signatureBase64: string,\n        payload: string,\n    ): Promise<boolean> {\n        try {\n            // Import public key from Base64 SPKI format\n            const publicKeyPEM = this.base64ToPEM(publicKeyBase64, 'PUBLIC KEY');\n\n            // Convert signature from Base64 to Buffer\n            const signatureBuffer = Buffer.from(signatureBase64, 'base64');\n\n            // Convert IEEE-P1363 format (raw 64 bytes) to DER format\n            const derSignature = this.p1363ToDER(signatureBuffer);\n\n            // Create verifier for ECDSA with P-256 curve and SHA-256\n            const verifier = createVerify('SHA256');\n            verifier.update(payload);\n            verifier.end();\n\n            // Verify the signature\n            const isValid = verifier.verify(\n                {\n                    key: publicKeyPEM,\n                    format: 'pem',\n                    type: 'spki',\n                },\n                derSignature,\n            );\n\n            return isValid;\n        } catch (error) {\n            console.error('Signature verification failed:', error);\n            return false;\n        }\n    }\n\n    /**\n     * Reconstruct the canonical payload that was signed by the client\n     * \n     * Format: kg-v1|{timestamp}|{METHOD}|{pathAndQuery}|{bodySha256}|{nonce}|{apiKey}|{keyId}\n     * \n     * @param params - Request parameters\n     * @returns Canonical payload string\n     */\n    reconstructPayload(params: {\n        timestamp: string;\n        method: string;\n        pathAndQuery: string;\n        bodySha256: string;\n        nonce: string;\n        apiKey: string;\n        keyId: string;\n    }): string {\n        const normalizedMethod = params.method.toUpperCase();\n\n        return `kg-v1|${params.timestamp}|${normalizedMethod}|${params.pathAndQuery}|${params.bodySha256}|${params.nonce}|${params.apiKey}|${params.keyId}`;\n    }\n\n    /**\n     * Hash request body with SHA-256 and return Base64\n     * \n     * @param body - Request body string\n     * @returns Base64-encoded SHA-256 hash\n     */\n    hashSha256(body: string): string {\n        const hash = createHash('sha256');\n        hash.update(body);\n        return hash.digest('base64');\n    }\n\n    /**\n     * Convert Base64-encoded key to PEM format\n     * \n     * @param base64Key - Base64-encoded key\n     * @param type - Key type (e.g., 'PUBLIC KEY', 'PRIVATE KEY')\n     * @returns PEM-formatted key\n     */\n    private base64ToPEM(base64Key: string, type: string): string {\n        const pemHeader = `-----BEGIN ${type}-----`;\n        const pemFooter = `-----END ${type}-----`;\n\n        // Split into 64-character lines as per PEM standard\n        const lines: string[] = [];\n        for (let i = 0; i < base64Key.length; i += 64) {\n            lines.push(base64Key.substring(i, i + 64));\n        }\n\n        return `${pemHeader}\\n${lines.join('\\n')}\\n${pemFooter}`;\n    }\n\n    /**\n     * Convert IEEE-P1363 signature format to DER format\n     * \n     * IEEE-P1363 is the raw format (r || s, each 32 bytes for P-256)\n     * DER is the ASN.1 format required by Node.js crypto.verify\n     * \n     * @param p1363Signature - IEEE-P1363 format signature (64 bytes)\n     * @returns DER-encoded signature\n     */\n    private p1363ToDER(p1363Signature: Buffer): Buffer {\n        if (p1363Signature.length !== 64) {\n            throw new Error('Invalid P-256 signature length (expected 64 bytes)');\n        }\n\n        // Extract r and s values (each 32 bytes)\n        const r = p1363Signature.subarray(0, 32);\n        const s = p1363Signature.subarray(32, 64);\n\n        // Encode r and s as DER integers\n        const rDER = this.encodeInteger(r);\n        const sDER = this.encodeInteger(s);\n\n        // Combine into DER sequence\n        const sequenceLength = rDER.length + sDER.length;\n        const der = Buffer.concat([\n            Buffer.from([0x30, sequenceLength]), // SEQUENCE tag and length\n            rDER,\n            sDER,\n        ]);\n\n        return der;\n    }\n\n    /**\n     * Encode a big-endian integer as DER\n     * \n     * @param value - Integer value as Buffer\n     * @returns DER-encoded integer\n     */\n    private encodeInteger(value: Buffer): Buffer {\n        // Remove leading zeros\n        let trimmed = value;\n        while (trimmed.length > 1 && trimmed[0] === 0x00) {\n            trimmed = trimmed.subarray(1);\n        }\n\n        // If the high bit is set, prepend 0x00 to indicate positive number\n        const firstByte = trimmed[0];\n        if (firstByte !== undefined && (firstByte & 0x80) !== 0) {\n            trimmed = Buffer.concat([Buffer.from([0x00]), trimmed]);\n        }\n\n        // INTEGER tag (0x02) followed by length and value\n        return Buffer.concat([Buffer.from([0x02, trimmed.length]), trimmed]);\n    }\n}\n"],"names":["CryptoService","verifySignature","publicKeyBase64","signatureBase64","payload","publicKeyPEM","base64ToPEM","signatureBuffer","Buffer","from","derSignature","p1363ToDER","verifier","createVerify","update","end","isValid","verify","key","format","type","error","console","reconstructPayload","params","normalizedMethod","method","toUpperCase","timestamp","pathAndQuery","bodySha256","nonce","apiKey","keyId","hashSha256","body","hash","createHash","digest","base64Key","pemHeader","pemFooter","lines","i","length","push","substring","join","p1363Signature","Error","r","subarray","s","rDER","encodeInteger","sDER","sequenceLength","der","concat","value","trimmed","firstByte","undefined"],"mappings":"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"}