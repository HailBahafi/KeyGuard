{"version":3,"sources":["../../../src/core/auth/auth.service.ts"],"sourcesContent":["import {\n  BadRequestException,\n  ConflictException,\n  Injectable,\n} from '@nestjs/common';\nimport { JwtService } from '@nestjs/jwt';\nimport dayjs from 'dayjs';\nimport { Hashing } from 'src/common/utils/hashing.util';\nimport { PrismaService } from '../database/prisma.service';\nimport { LoginDto } from './dto/login.dto';\nimport { SignupDto } from './dto/signup.dto';\nimport { UserRole } from 'src/generated/enums';\n@Injectable()\nexport class AuthService {\n  constructor(\n    private readonly jwtService: JwtService,\n    private readonly prismaService: PrismaService,\n  ) {}\n  async login(loginDto: LoginDto) {\n    const user = await this.prismaService.prisma.user.findFirst({\n      where: {\n        OR: [{ email: loginDto.email }, { username: loginDto.username }],\n      },\n      select: {\n        id: true,\n        username: true,\n        password: true,\n      },\n    });\n    if (!user) throw new BadRequestException('username or email is incorrect');\n    await Hashing.compareOrFail(loginDto.password, user.password);\n    const payload = {\n      id: user.id,\n      username: user.username,\n    };\n    await this.prismaService.prisma.user.update({\n      where: { id: user.id },\n      data: { lastLogin: dayjs().toDate() },\n    });\n    return {\n      id: user.id,\n      token: await this.jwtService.signAsync(payload, { expiresIn: '7d' }),\n    };\n  }\n  async signup(signupDto: SignupDto) {\n    const user = await this.prismaService.prisma.user.findFirst({\n      where: {\n        OR: [{ email: signupDto.email }, { username: signupDto.username }],\n      },\n      select: { id: true },\n    });\n    if (user) throw new ConflictException('User already exists');\n    const hashedPassword = await Hashing.hash(signupDto.password);\n    const newUser = await this.prismaService.prisma.user.create({\n      data: {\n        ...signupDto,\n        password: hashedPassword,\n        role: UserRole.SELLER,\n        lastLogin: dayjs().toDate(),\n      },\n      select: { id: true, username: true },\n    });\n\n    const userPayload = {\n      id: newUser.id,\n      username: newUser.username,\n    };\n    return {\n      id: newUser.id,\n      token: this.jwtService.sign(userPayload, { expiresIn: '7d' }),\n    };\n  }\n}\n"],"names":["AuthService","login","loginDto","user","prismaService","prisma","findFirst","where","OR","email","username","select","id","password","BadRequestException","Hashing","compareOrFail","payload","update","data","lastLogin","dayjs","toDate","token","jwtService","signAsync","expiresIn","signup","signupDto","ConflictException","hashedPassword","hash","newUser","create","role","UserRole","SELLER","userPayload","sign"],"mappings":";;;;+BAaaA;;;eAAAA;;;wBATN;qBACoB;8DACT;6BACM;+BACM;uBAGL;;;;;;;;;;;;;;;AAElB,IAAA,AAAMA,cAAN,MAAMA;IAKX,MAAMC,MAAMC,QAAkB,EAAE;QAC9B,MAAMC,OAAO,MAAM,IAAI,CAACC,aAAa,CAACC,MAAM,CAACF,IAAI,CAACG,SAAS,CAAC;YAC1DC,OAAO;gBACLC,IAAI;oBAAC;wBAAEC,OAAOP,SAASO,KAAK;oBAAC;oBAAG;wBAAEC,UAAUR,SAASQ,QAAQ;oBAAC;iBAAE;YAClE;YACAC,QAAQ;gBACNC,IAAI;gBACJF,UAAU;gBACVG,UAAU;YACZ;QACF;QACA,IAAI,CAACV,MAAM,MAAM,IAAIW,2BAAmB,CAAC;QACzC,MAAMC,oBAAO,CAACC,aAAa,CAACd,SAASW,QAAQ,EAAEV,KAAKU,QAAQ;QAC5D,MAAMI,UAAU;YACdL,IAAIT,KAAKS,EAAE;YACXF,UAAUP,KAAKO,QAAQ;QACzB;QACA,MAAM,IAAI,CAACN,aAAa,CAACC,MAAM,CAACF,IAAI,CAACe,MAAM,CAAC;YAC1CX,OAAO;gBAAEK,IAAIT,KAAKS,EAAE;YAAC;YACrBO,MAAM;gBAAEC,WAAWC,IAAAA,cAAK,IAAGC,MAAM;YAAG;QACtC;QACA,OAAO;YACLV,IAAIT,KAAKS,EAAE;YACXW,OAAO,MAAM,IAAI,CAACC,UAAU,CAACC,SAAS,CAACR,SAAS;gBAAES,WAAW;YAAK;QACpE;IACF;IACA,MAAMC,OAAOC,SAAoB,EAAE;QACjC,MAAMzB,OAAO,MAAM,IAAI,CAACC,aAAa,CAACC,MAAM,CAACF,IAAI,CAACG,SAAS,CAAC;YAC1DC,OAAO;gBACLC,IAAI;oBAAC;wBAAEC,OAAOmB,UAAUnB,KAAK;oBAAC;oBAAG;wBAAEC,UAAUkB,UAAUlB,QAAQ;oBAAC;iBAAE;YACpE;YACAC,QAAQ;gBAAEC,IAAI;YAAK;QACrB;QACA,IAAIT,MAAM,MAAM,IAAI0B,yBAAiB,CAAC;QACtC,MAAMC,iBAAiB,MAAMf,oBAAO,CAACgB,IAAI,CAACH,UAAUf,QAAQ;QAC5D,MAAMmB,UAAU,MAAM,IAAI,CAAC5B,aAAa,CAACC,MAAM,CAACF,IAAI,CAAC8B,MAAM,CAAC;YAC1Dd,MAAM;gBACJ,GAAGS,SAAS;gBACZf,UAAUiB;gBACVI,MAAMC,eAAQ,CAACC,MAAM;gBACrBhB,WAAWC,IAAAA,cAAK,IAAGC,MAAM;YAC3B;YACAX,QAAQ;gBAAEC,IAAI;gBAAMF,UAAU;YAAK;QACrC;QAEA,MAAM2B,cAAc;YAClBzB,IAAIoB,QAAQpB,EAAE;YACdF,UAAUsB,QAAQtB,QAAQ;QAC5B;QACA,OAAO;YACLE,IAAIoB,QAAQpB,EAAE;YACdW,OAAO,IAAI,CAACC,UAAU,CAACc,IAAI,CAACD,aAAa;gBAAEX,WAAW;YAAK;QAC7D;IACF;IAzDA,YACE,AAAiBF,UAAsB,EACvC,AAAiBpB,aAA4B,CAC7C;aAFiBoB,aAAAA;aACApB,gBAAAA;IAChB;AAuDL"}