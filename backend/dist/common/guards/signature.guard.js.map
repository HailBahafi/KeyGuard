{"version":3,"sources":["../../../src/common/guards/signature.guard.ts"],"sourcesContent":["import { CanActivate, ExecutionContext, Injectable, UnauthorizedException } from '@nestjs/common';\nimport { FastifyRequest } from 'fastify';\nimport { CryptoService } from '../../modules/keyguard/services/crypto.service';\n\n/**\n * SignatureGuard - Validates KeyGuard cryptographic signatures\n * \n * Protects endpoints by verifying device-bound request signatures\n */\n@Injectable()\nexport class SignatureGuard implements CanActivate {\n    // TODO: Replace with database lookup once device enrollment is implemented\n    // For now, using hardcoded public key for testing\n    // You can generate a test key pair by running: node test.js\n    private readonly HARDCODED_PUBLIC_KEY = 'MFkwEwYHKoZIzj0CAQYIKoZIzj0DAQcDQgAEyw2fLJBv+YxDdd8ZTK795LX11MTcvhC0YZ2pTO84lsR+IllKguWHJ8ZxCF3a9VA3iw4LE1cGtElypNhWF2bFmA==';\n\n    private readonly TIME_WINDOW_SECONDS = 10;\n\n    constructor(private readonly cryptoService: CryptoService) { }\n\n    async canActivate(context: ExecutionContext): Promise<boolean> {\n        const request = context.switchToHttp().getRequest<FastifyRequest>();\n\n        // Extract KeyGuard headers\n        const signature = this.getHeader(request, 'x-keyguard-signature');\n        const timestamp = this.getHeader(request, 'x-keyguard-timestamp');\n        const nonce = this.getHeader(request, 'x-keyguard-nonce');\n        const bodySha256 = this.getHeader(request, 'x-keyguard-body-sha256');\n        const keyId = this.getHeader(request, 'x-keyguard-key-id');\n        const apiKey = this.getHeader(request, 'x-keyguard-api-key');\n\n        // Validate all required headers are present\n        if (!signature || !timestamp || !nonce || !bodySha256 || !keyId || !apiKey) {\n            throw new UnauthorizedException('Missing required KeyGuard headers');\n        }\n\n        // Validate timestamp is within acceptable time window\n        this.validateTimestamp(timestamp);\n\n        // Reconstruct the canonical payload\n        const method = request.method;\n        const url = request.url;\n\n        // Extract path and query from URL\n        const pathAndQuery = this.extractPathAndQuery(url);\n\n        const payload = this.cryptoService.reconstructPayload({\n            timestamp,\n            method,\n            pathAndQuery,\n            bodySha256,\n            nonce,\n            apiKey,\n            keyId,\n        });\n\n        // Verify the signature\n        const isValid = await this.cryptoService.verifySignature(\n            this.HARDCODED_PUBLIC_KEY,\n            signature,\n            payload,\n        );\n\n        if (!isValid) {\n            throw new UnauthorizedException('Invalid signature');\n        }\n\n        return true;\n    }\n\n    /**\n     * Get header value from request (case-insensitive)\n     */\n    private getHeader(request: FastifyRequest, headerName: string): string | undefined {\n        const value = request.headers[headerName.toLowerCase()];\n        return Array.isArray(value) ? value[0] : value;\n    }\n\n    /**\n     * Validate timestamp is within acceptable time window\n     */\n    private validateTimestamp(timestamp: string): void {\n        try {\n            const requestTime = new Date(timestamp).getTime();\n            const currentTime = Date.now();\n            const diffSeconds = Math.abs(currentTime - requestTime) / 1000;\n\n            if (diffSeconds > this.TIME_WINDOW_SECONDS) {\n                throw new UnauthorizedException(\n                    `Request timestamp outside acceptable window (${this.TIME_WINDOW_SECONDS}s)`,\n                );\n            }\n        } catch (error) {\n            if (error instanceof UnauthorizedException) {\n                throw error;\n            }\n            throw new UnauthorizedException('Invalid timestamp format');\n        }\n    }\n\n    /**\n     * Extract path and query from URL\n     */\n    private extractPathAndQuery(url: string): string {\n        // URL already includes path and query (e.g., \"/api/v1/verify-test?foo=bar\")\n        // If it starts with full URL, parse it\n        if (url.startsWith('http://') || url.startsWith('https://')) {\n            try {\n                const urlObj = new URL(url);\n                return urlObj.pathname + urlObj.search;\n            } catch {\n                return url;\n            }\n        }\n        return url;\n    }\n}\n"],"names":["SignatureGuard","canActivate","context","request","switchToHttp","getRequest","signature","getHeader","timestamp","nonce","bodySha256","keyId","apiKey","UnauthorizedException","validateTimestamp","method","url","pathAndQuery","extractPathAndQuery","payload","cryptoService","reconstructPayload","isValid","verifySignature","HARDCODED_PUBLIC_KEY","headerName","value","headers","toLowerCase","Array","isArray","requestTime","Date","getTime","currentTime","now","diffSeconds","Math","abs","TIME_WINDOW_SECONDS","error","startsWith","urlObj","URL","pathname","search"],"mappings":";;;;+BAUaA;;;eAAAA;;;wBAVoE;+BAEnD;;;;;;;;;;AAQvB,IAAA,AAAMA,iBAAN,MAAMA;IAUT,MAAMC,YAAYC,OAAyB,EAAoB;QAC3D,MAAMC,UAAUD,QAAQE,YAAY,GAAGC,UAAU;QAEjD,2BAA2B;QAC3B,MAAMC,YAAY,IAAI,CAACC,SAAS,CAACJ,SAAS;QAC1C,MAAMK,YAAY,IAAI,CAACD,SAAS,CAACJ,SAAS;QAC1C,MAAMM,QAAQ,IAAI,CAACF,SAAS,CAACJ,SAAS;QACtC,MAAMO,aAAa,IAAI,CAACH,SAAS,CAACJ,SAAS;QAC3C,MAAMQ,QAAQ,IAAI,CAACJ,SAAS,CAACJ,SAAS;QACtC,MAAMS,SAAS,IAAI,CAACL,SAAS,CAACJ,SAAS;QAEvC,4CAA4C;QAC5C,IAAI,CAACG,aAAa,CAACE,aAAa,CAACC,SAAS,CAACC,cAAc,CAACC,SAAS,CAACC,QAAQ;YACxE,MAAM,IAAIC,6BAAqB,CAAC;QACpC;QAEA,sDAAsD;QACtD,IAAI,CAACC,iBAAiB,CAACN;QAEvB,oCAAoC;QACpC,MAAMO,SAASZ,QAAQY,MAAM;QAC7B,MAAMC,MAAMb,QAAQa,GAAG;QAEvB,kCAAkC;QAClC,MAAMC,eAAe,IAAI,CAACC,mBAAmB,CAACF;QAE9C,MAAMG,UAAU,IAAI,CAACC,aAAa,CAACC,kBAAkB,CAAC;YAClDb;YACAO;YACAE;YACAP;YACAD;YACAG;YACAD;QACJ;QAEA,uBAAuB;QACvB,MAAMW,UAAU,MAAM,IAAI,CAACF,aAAa,CAACG,eAAe,CACpD,IAAI,CAACC,oBAAoB,EACzBlB,WACAa;QAGJ,IAAI,CAACG,SAAS;YACV,MAAM,IAAIT,6BAAqB,CAAC;QACpC;QAEA,OAAO;IACX;IAEA;;KAEC,GACD,AAAQN,UAAUJ,OAAuB,EAAEsB,UAAkB,EAAsB;QAC/E,MAAMC,QAAQvB,QAAQwB,OAAO,CAACF,WAAWG,WAAW,GAAG;QACvD,OAAOC,MAAMC,OAAO,CAACJ,SAASA,KAAK,CAAC,EAAE,GAAGA;IAC7C;IAEA;;KAEC,GACD,AAAQZ,kBAAkBN,SAAiB,EAAQ;QAC/C,IAAI;YACA,MAAMuB,cAAc,IAAIC,KAAKxB,WAAWyB,OAAO;YAC/C,MAAMC,cAAcF,KAAKG,GAAG;YAC5B,MAAMC,cAAcC,KAAKC,GAAG,CAACJ,cAAcH,eAAe;YAE1D,IAAIK,cAAc,IAAI,CAACG,mBAAmB,EAAE;gBACxC,MAAM,IAAI1B,6BAAqB,CAC3B,CAAC,6CAA6C,EAAE,IAAI,CAAC0B,mBAAmB,CAAC,EAAE,CAAC;YAEpF;QACJ,EAAE,OAAOC,OAAO;YACZ,IAAIA,iBAAiB3B,6BAAqB,EAAE;gBACxC,MAAM2B;YACV;YACA,MAAM,IAAI3B,6BAAqB,CAAC;QACpC;IACJ;IAEA;;KAEC,GACD,AAAQK,oBAAoBF,GAAW,EAAU;QAC7C,4EAA4E;QAC5E,uCAAuC;QACvC,IAAIA,IAAIyB,UAAU,CAAC,cAAczB,IAAIyB,UAAU,CAAC,aAAa;YACzD,IAAI;gBACA,MAAMC,SAAS,IAAIC,IAAI3B;gBACvB,OAAO0B,OAAOE,QAAQ,GAAGF,OAAOG,MAAM;YAC1C,EAAE,OAAM;gBACJ,OAAO7B;YACX;QACJ;QACA,OAAOA;IACX;IAjGA,YAAY,AAAiBI,aAA4B,CAAE;aAA9BA,gBAAAA;QAP7B,2EAA2E;QAC3E,kDAAkD;QAClD,4DAA4D;aAC3CI,uBAAuB;aAEvBe,sBAAsB;IAEsB;AAkGjE"}