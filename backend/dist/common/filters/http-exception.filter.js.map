{"version":3,"sources":["../../../src/common/filters/http-exception.filter.ts"],"sourcesContent":["import {\n  ArgumentsHost,\n  BadRequestException,\n  Catch,\n  ExceptionFilter,\n  HttpException,\n  HttpStatus,\n  Inject,\n  Logger,\n} from '@nestjs/common';\n\nimport { ValidationError } from 'class-validator';\nimport dayjs from 'dayjs';\nimport { FastifyReply, FastifyRequest } from 'fastify';\nimport { WINSTON_MODULE_PROVIDER } from 'nest-winston';\nimport { Logger as WinstonLogger } from 'winston';\nimport { TooManyRequestsException } from '../exceptions/too-many-requests.exception';\nimport { isProduction } from '../utils/is-environment.util';\nimport { PrismaErrorCode, prismaErrorMap } from './prisma-error-codes';\nimport { ErrorResponse, PrismaErrorResult } from './prisma-errors.interface';\nimport { PrismaClientKnownRequestError, PrismaClientUnknownRequestError, PrismaClientRustPanicError, PrismaClientInitializationError, PrismaClientValidationError } from '@prisma/client/runtime/client';\n\n/**\n * Enhanced Prisma Exception Filter combining comprehensive error handling\n * with detailed field extraction and user-friendly error messages\n *\n * Features:\n * - Complete coverage of all Prisma error codes (P1xxx, P2xxx, P3xxx, P4xxx, P6xxx)\n * - Smart field extraction from error messages and metadata\n * - Environment-aware error responses (detailed in dev, sanitized in prod)\n * - Comprehensive logging with request context\n * - Support for class-validator integration\n * - Rate limiting and custom exception support\n */\n@Catch()\nexport class HttpExceptionFilter implements ExceptionFilter {\n  private readonly logger = new Logger(HttpExceptionFilter.name);\n\n  constructor(@Inject(WINSTON_MODULE_PROVIDER) private readonly winstonLogger: WinstonLogger) {}\n\n  async catch(exception: any, host: ArgumentsHost): Promise<void> {\n    const ctx = host.switchToHttp();\n    const request = ctx.getRequest<FastifyRequest>();\n    const reply = ctx.getResponse<FastifyReply>();\n\n    const isProd = isProduction();\n    let status = HttpStatus.INTERNAL_SERVER_ERROR;\n    let message = exception.message;\n    let errors: Record<string, string[] | undefined> = {};\n    let code: string | undefined;\n    let details: any;\n\n    // Handle different exception types with enhanced logic\n    if (exception instanceof PrismaClientKnownRequestError) {\n      ({ status, message, errors, code, details } = this.handlePrismaKnownError(exception));\n    } else if (exception instanceof PrismaClientUnknownRequestError) {\n      ({ status, message, errors, details } = this.handlePrismaUnknownError(exception));\n    } else if (exception instanceof PrismaClientRustPanicError) {\n      ({ status, message, errors, details } = this.handlePrismaRustPanicError(exception));\n    } else if (exception instanceof PrismaClientInitializationError) {\n      ({ status, message, errors, details } = this.handlePrismaInitializationError(exception));\n    } else if (exception instanceof PrismaClientValidationError) {\n      ({ status, message, errors, details } = this.handlePrismaValidationError(exception));\n    } else if (exception instanceof BadRequestException) {\n      ({ status, message, errors } = await this.handleBadRequestException(exception));\n    } else if (exception instanceof TooManyRequestsException) {\n      ({ status, message, errors } = this.handleTooManyRequestsException(exception));\n    } else if (exception instanceof HttpException) {\n      ({ status, message, errors } = this.handleHttpException(exception));\n    } else if (exception instanceof Error) {\n      ({ status, message, errors } = this.handleGenericError(exception));\n    }\n\n    // Log the error with comprehensive context\n    this.logError(exception, request, status, message, errors);\n\n    // Build error response\n    const errorResponse: ErrorResponse = {\n      statusCode: status,\n      timestamp: dayjs().format(),\n      message,\n      path: request.url,\n    };\n\n    // Add error code if available\n    if (code) {\n      errorResponse.code = code;\n    }\n\n    // Include detailed errors based on environment and error type\n    if (!isProd) {\n      errorResponse.errors = errors;\n      errorResponse.details = details;\n    }\n\n    reply.status(status).send(errorResponse);\n  }\n\n  /**\n   * Handle known Prisma errors with comprehensive error code coverage\n   * and intelligent field extraction\n   */\n  private handlePrismaKnownError(exception: PrismaClientKnownRequestError): PrismaErrorResult {\n    let status = HttpStatus.BAD_REQUEST;\n    let message = exception.message;\n    let errors: Record<string, string[]> = {};\n    const code = exception.code as PrismaErrorCode;\n    const details = {\n      originalMessage: exception.message,\n      meta: exception.meta,\n    };\n\n    const prismaErrorHandler = prismaErrorMap[code];\n    if (prismaErrorHandler) {\n      status = prismaErrorHandler.status;\n      message = prismaErrorHandler.message;\n      errors = prismaErrorHandler.buildErrors?.(exception) || {};\n    }\n\n    return { status, message, errors, code, details };\n  }\n\n  /**\n   * Handle unknown Prisma runtime errors\n   */\n  private handlePrismaUnknownError(exception: PrismaClientUnknownRequestError): PrismaErrorResult {\n    return {\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\n      message: 'Unknown database error occurred',\n      errors: { database: ['An unknown database error occurred'] },\n      details: {\n        originalMessage: exception.message,\n        type: 'PrismaClientUnknownRequestError',\n      },\n    };\n  }\n\n  /**\n   * Handle Prisma engine panics\n   */\n  private handlePrismaRustPanicError(exception: PrismaClientRustPanicError): PrismaErrorResult {\n    return {\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\n      message: 'Critical database engine error',\n      errors: { engine: ['A critical database engine error occurred. Please contact support.'] },\n      details: {\n        type: 'PrismaClientRustPanicError',\n        originalMessage: exception.message,\n      },\n    };\n  }\n\n  /**\n   * Handle Prisma client initialization errors\n   */\n  private handlePrismaInitializationError(\n    exception: PrismaClientInitializationError,\n  ): PrismaErrorResult {\n    return {\n      status: HttpStatus.SERVICE_UNAVAILABLE,\n      message: 'Database service temporarily unavailable',\n      errors: {\n        initialization: ['Database client initialization failed. Please try again later.'],\n      },\n      details: {\n        type: 'PrismaClientInitializationError',\n        errorCode: exception.errorCode,\n        originalMessage: exception.message,\n      },\n    };\n  }\n\n  /**\n   * Handle Prisma validation errors\n   */\n  private handlePrismaValidationError(exception: PrismaClientValidationError): PrismaErrorResult {\n    return {\n      status: HttpStatus.BAD_REQUEST,\n      message: 'Invalid request parameters',\n      errors: { validation: [this.sanitizeValidationMessage(exception.message)] },\n      details: {\n        type: 'PrismaClientValidationError',\n        originalMessage: exception.message,\n      },\n    };\n  }\n\n  /**\n   * Handle BadRequestException (typically validation errors)\n   */\n  private async handleBadRequestException(exception: BadRequestException) {\n    const status = exception.getStatus();\n    const response = exception.getResponse() as any;\n    const rawErrors = Array.isArray(response.message) ? response.message : [response.message];\n\n    return {\n      status,\n      message: response.message || 'Validation failed',\n      errors: Array.isArray(rawErrors)\n        ? await this.formatValidationErrors(rawErrors)\n        : { validation: rawErrors },\n    };\n  }\n\n  /**\n   * Handle TooManyRequestsException\n   */\n  private handleTooManyRequestsException(exception: TooManyRequestsException) {\n    return {\n      status: HttpStatus.TOO_MANY_REQUESTS,\n      message: 'Rate limit exceeded',\n      errors: { rateLimit: [exception.message || 'Too many requests'] },\n    };\n  }\n\n  /**\n   * Handle generic HttpException\n   */\n  private handleHttpException(exception: HttpException) {\n    const status = exception.getStatus();\n    const response = exception.getResponse() as any;\n\n    return {\n      status,\n      message: response.message || exception.message,\n      errors: response.errors || null,\n    };\n  }\n\n  /**\n   * Handle generic Error\n   */\n  private handleGenericError(exception: Error) {\n    return {\n      status: HttpStatus.INTERNAL_SERVER_ERROR,\n      message: exception.message,\n      errors: { server: [exception.message], stack: exception.stack?.split('\\n') || [] },\n    };\n  }\n\n  /**\n   * Format validation errors from class-validator\n   */\n  private async formatValidationErrors(\n    errors: ValidationError[],\n  ): Promise<Record<string, string[]>> {\n    const formatted: Record<string, string[]> = {};\n\n    for (const error of errors) {\n      if (error.constraints) {\n        formatted[error.property] = Object.values(error.constraints);\n      }\n\n      if (error.children && error.children.length > 0) {\n        const childErrors = await this.formatValidationErrors(error.children);\n        for (const [key, value] of Object.entries(childErrors)) {\n          formatted[`${error.property}.${key}`] = value;\n        }\n      }\n    }\n\n    return formatted;\n  }\n\n  /**\n   * Sanitize validation error messages to remove sensitive information\n   */\n  private sanitizeValidationMessage(message: string): string {\n    if (!message) return 'Validation error occurred';\n\n    return message\n      .replace(/Argument `.*?`:/g, 'Argument:')\n      .replace(/at `.*?`/g, 'at field')\n      .replace(/Type `.*?`/g, 'Type')\n      .replace(/Path `.*?`/g, 'Path')\n      .substring(0, 500); // Limit message length\n  }\n\n  /**\n   * Sanitize request body to remove sensitive information\n   */\n  private sanitizeRequestBody(body: any): any {\n    if (!body || typeof body !== 'object') {\n      return body;\n    }\n\n    const sensitiveFields = [\n      'password',\n      'token',\n      'secret',\n      'apiKey',\n      'authorization',\n      'auth',\n      'key',\n      'private',\n      'confidential',\n    ];\n\n    const sanitized = { ...body };\n\n    const sanitizeObject = (obj: any, prefix = ''): any => {\n      if (!obj || typeof obj !== 'object') return obj;\n\n      const result: any = Array.isArray(obj) ? [] : {};\n\n      for (const [key, value] of Object.entries(obj)) {\n        const fullKey = prefix ? `${prefix}.${key}` : key;\n        const lowerKey = key.toLowerCase();\n\n        if (sensitiveFields.some(field => lowerKey.includes(field))) {\n          result[key] = '[REDACTED]';\n        } else if (typeof value === 'object' && value !== null) {\n          result[key] = sanitizeObject(value, fullKey);\n        } else {\n          result[key] = value;\n        }\n      }\n\n      return result;\n    };\n\n    return sanitizeObject(sanitized);\n  }\n\n  /**\n   * Log error with comprehensive context and appropriate log levels\n   */\n  private logError(\n    exception: any,\n    request: FastifyRequest,\n    status: number,\n    message: string,\n    errors: Record<string, string[] | undefined>,\n  ): void {\n    // Determine log level based on status code and error type\n    let logLevel: string;\n    if (status >= 500) {\n      logLevel = 'error';\n    } else if (status >= 400) {\n      logLevel = 'warn';\n    } else {\n      logLevel = 'info';\n    }\n\n    // Build comprehensive log data\n    const logData = {\n      timestamp: dayjs().format(),\n      level: logLevel,\n      method: request.method,\n      url: request.url,\n      userAgent: request.headers['user-agent'],\n      userId: (request as any).user?.id || 'anonymous',\n      ip: request.ip,\n      status,\n      message,\n      errors,\n\n      // Error context\n      errorType: exception.constructor.name,\n      errorCode: exception.code,\n\n      // Request context (sanitized)\n      requestId: request.id,\n      correlationId: request.headers['x-correlation-id'],\n\n      // Performance data\n      responseTime: Date.now() - ((request as any).startTime || Date.now()),\n\n      // Include stack trace for server errors in non-prod\n      ...(status >= 500 && {\n        stack: exception.stack,\n        originalMessage: exception.message,\n      }),\n\n      // Include request body for client errors (sanitized)\n      ...(status >= 400 &&\n        status < 500 && {\n          body: this.sanitizeRequestBody(request.body),\n          query: request.query,\n          params: request.params,\n        }),\n\n      // Additional Prisma-specific context\n      ...(exception.meta && { meta: exception.meta }),\n    };\n\n    // Log using both NestJS logger and Winston\n    switch (logLevel) {\n      case 'error':\n        this.logger.error(message, logData);\n        this.winstonLogger.error(message, logData);\n        break;\n      case 'warn':\n        this.logger.warn(message, logData);\n        this.winstonLogger.warn(message, logData);\n        break;\n      default:\n        this.logger.log(message, logData);\n        this.winstonLogger.info(message, logData);\n    }\n\n    // Additional monitoring/alerting for critical errors\n    if (status >= 500) {\n      this.handleCriticalError(exception, logData);\n    }\n  }\n\n  /**\n   * Handle critical errors that require immediate attention\n   */\n  private handleCriticalError(exception: any, logData: any): void {\n    // You can integrate with monitoring services here\n    // Examples: Sentry, DataDog, New Relic, etc.\n\n    // For now, log as critical\n    this.logger.error(`CRITICAL ERROR: ${exception.message}`, {\n      ...logData,\n      critical: true,\n      alertRequired: true,\n    });\n\n    // You could also send alerts, create incidents, etc.\n    // this.alertingService.sendCriticalAlert(exception, logData);\n    // this.incidentService.createIncident(exception, logData);\n  }\n}\n"],"names":["HttpExceptionFilter","catch","exception","host","ctx","switchToHttp","request","getRequest","reply","getResponse","isProd","isProduction","status","HttpStatus","INTERNAL_SERVER_ERROR","message","errors","code","details","PrismaClientKnownRequestError","handlePrismaKnownError","PrismaClientUnknownRequestError","handlePrismaUnknownError","PrismaClientRustPanicError","handlePrismaRustPanicError","PrismaClientInitializationError","handlePrismaInitializationError","PrismaClientValidationError","handlePrismaValidationError","BadRequestException","handleBadRequestException","TooManyRequestsException","handleTooManyRequestsException","HttpException","handleHttpException","Error","handleGenericError","logError","errorResponse","statusCode","timestamp","dayjs","format","path","url","send","BAD_REQUEST","originalMessage","meta","prismaErrorHandler","prismaErrorMap","buildErrors","database","type","engine","SERVICE_UNAVAILABLE","initialization","errorCode","validation","sanitizeValidationMessage","getStatus","response","rawErrors","Array","isArray","formatValidationErrors","TOO_MANY_REQUESTS","rateLimit","server","stack","split","formatted","error","constraints","property","Object","values","children","length","childErrors","key","value","entries","replace","substring","sanitizeRequestBody","body","sensitiveFields","sanitized","sanitizeObject","obj","prefix","result","fullKey","lowerKey","toLowerCase","some","field","includes","logLevel","logData","level","method","userAgent","headers","userId","user","id","ip","errorType","name","requestId","correlationId","responseTime","Date","now","startTime","query","params","logger","winstonLogger","warn","log","info","handleCriticalError","critical","alertRequired","Logger"],"mappings":"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"}